{% load static %}
{% load bootstrap5 %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Rotation with Fabric.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    {% bootstrap_css %}
    <!-- Include jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <style>
        .canvas-container {
            border: 1px solid #d00;
            position: relative;
            width: 500px;
            height: 500px;
        }
        #map{
            height: 500px;
            width: 500px;
        }
        body {
            overflow: hidden; /* Disable scrolling */
        }
        #canvas {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100">
            <div class="col-md-2 h-100 tools">
                <div id="coordinates">
                    <h3>Icon List</h3>
                    <ul id="icon-list-items"></ul>
                </div>
            </div>
            <div class="col-md-5 column-left p-0 m-0 h-100">
                <div id="map" class=""></div>
            </div>
            <div class="col-md-5 column-right p-0 m-0 h-100">            
             
                    <canvas id="canvas" ></canvas>
            
            </div>
        </div>
    <div>

    <script>

        $(document).ready(function() {
            // Initialize Leaflet map
            const map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            // Add a marker to the map
            const marker = L.marker([0, 0]).addTo(map);

            // Update the marker position based on the map click event
            map.on('click', function(event) {
                const lat = event.latlng.lat;
                const lon = event.latlng.lng;
                marker.setLatLng([lat, lon]);
                $('#coordinates').text(`Latitude: ${lat.toFixed(4)}, Longitude: ${lon.toFixed(4)}`);
            });
        });

       
        // Initialize Fabric.js canvas
        const canvas = new fabric.Canvas('canvas',{
            fireRightClick: true, // Enable right-click events
            stopContextMenu: true, // Disable the default context menu
            selection: false // Disable object selection
        });
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const imageUrl = "{% static 'images/ISS030-E-274867.JPG' %}";

        // Load an image into the Fabric canvas
        fabric.Image.fromURL(imageUrl, function(img) {
            const scaleX = canvasWidth / img.width;
            const scaleY = canvasHeight / img.height;
            const scale = Math.min(scaleX, scaleY);
            img.set({
                left: (canvasWidth - img.width * scale) / 2, // Center horizontally
                top: (canvasHeight - img.height * scale) / 2, // Center vertically
                originX: 'left',
                originY: 'top',
                scaleX: scale,
                scaleY: scale,
                selectable: false, // Make the image non-selectable to avoid default transformations
                hasControls: false, // Disable controls for the image
                hasBorders: false, // Disable borders for the image
            });
            const group = new fabric.Group([img], {
                left: canvasWidth / 2,
                top: canvasHeight / 2,
                originX: 'center',
                originY: 'center',
                selectable: false, // Make the group non-selectable
                hasControls: false, // Disable controls for the group
                hasBorders: false, // Disable borders for the group
            });
            canvas.add(group);


            let isRightClickDragging = false; // Flag to track right-click drag state
            let isDragging = false; // Flag to track left-click drag state
            let startX; // Initial X position for rotation calculation
            let iconCounter = 1; // Counter for numbering icons
            let iconList = []; // List to store icon objects
            let isPKeyActive = false;
            let isDKeyActive = false;
            const originalIconScale = 1.05; // Original scale for icons

            document.addEventListener('keydown', function(event) {
                if (event.key === 'p' || event.key === 'P') {
                    isPKeyActive = true;
                }
            });
               // Track the "p" key release
            document.addEventListener('keyup', function(e) {
                if (e.key === 'p' || e.key === 'P') {
                    isPKeyActive = false;
                }
            });
            document.addEventListener('keydown', function(event) {
                if (event.key === 'd' || event.key === 'D') {
                    isDKeyActive = true;
                }
            });
            document.addEventListener('keyup', function(e) {
                if (e.key === 'd' || e.key === 'D') {
                    isDKeyActive = false;
                }
            });

            function addIcon(iconURL, x, y) {
                fabric.Image.fromURL(iconURL, function(icon) {
                    icon.set({
                        left: x ,
                        top: y ,
                        originX: 'center',
                        originY: 'center',
                        scaleX: 0.05, // Example scale for the icon
                        scaleY: 0.05,
                        selectable: false,  // Make the icon non-selectable
                        hasControls: false, // Disable controls for the icon
                        hasBorders: false   // Disable borders for the icon
                    });
                    const label = new fabric.Text(iconCounter.toString(), {
                        left: icon.left,
                        top: icon.top - 15, // Position the label above the icon
                        fontSize: 16,
                        fill: 'red',
                        originX: 'center',
                        originY: 'center',
                        selectable: false,  // Make the label non-selectable
                        hasControls: false, // Disable controls for the label
                        hasBorders: false   // Disable borders for the label
                    });

                    // Create a unique ID for the icon
                    const iconID = `icon-${iconCounter}`;

                    iconCounter++; // Increment the icon counter
                

                    const iconGroup = new fabric.Group([icon, label], {
                        left: x,
                        top: y,
                        originX: 'center',
                        originY: 'center',
                        selectable: true,  // Make the group selectable
                        hasControls: false, // Disable controls for the group
                        hasBorders: false   // Disable borders for the group
                    });

                    // Store the icon object in the list
                    iconList.push({
                        id: iconID,
                        px: iconGroup.left,
                        py: iconGroup.top,
                    });

                    updateIconList(); // Update the icon list displayed in the div
                    group.addWithUpdate(iconGroup); // Add the icon to the group
                    canvas.requestRenderAll(); // Re-render the canvas
                }, { crossOrigin: 'anonymous' }); // Handle CORS issues
            }

            function deleteNearestIconGroup(px, py) {
                let closestIconGroup = null;
                let closestDistance = Infinity;

                // Iterate over all objects in the group to find the closest one
                group.getObjects().forEach(function(obj) {
                    if (obj !== img) { // Exclude the main image
                        const dx = obj.left - px;
                        const dy = obj.top - py;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestIconGroup = obj;
                        }
                    }
                });

                // Remove the closest icon group if found
                if (closestIconGroup) {
                    group.remove(closestIconGroup);
                    iconList = iconList.filter(icon => icon.id !== closestIconGroup.id);
                    console.log(iconList);
                    updateIconList(); // Update the icon list displayed in the div
                    canvas.requestRenderAll(); // Re-render the canvas
                }
            }

            // Function to update the icon list in the div
            function updateIconList() {
                const listContainer = document.getElementById('icon-list-items');
                listContainer.innerHTML = ''; // Clear the current list

                // Create list items for each icon in iconList
                iconList.forEach(function(icon) {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${icon.id}, X: ${icon.px.toFixed(2)}, Y: ${icon.py.toFixed(2)}`;
                    listContainer.appendChild(listItem);
                });
            }

            // Function to convert canvas click coordinates to image coordinates
            function getImageCoordinates(event) {
                // Get the pointer position on the canvas
                const pointer = canvas.getPointer(event.e);

                // Create a point from the click position
                const clickPoint = new fabric.Point(pointer.x, pointer.y);

                // Get the inverse transform matrix of the group
                const inverseGroupMatrix = fabric.util.invertTransform(img.calcTransformMatrix());

                // Transform the click point to the image's local coordinates
                const transformedPoint = fabric.util.transformPoint(clickPoint, inverseGroupMatrix);

                return { px: transformedPoint.x + img.width/2, py: transformedPoint.y+img.height/2 };
            }
            

            // Mouse wheel
            canvas.on('mouse:wheel', function(event) {
                const delta = event.e.deltaY; // Get the scroll direction
                let zoom = group.scaleX + delta / 300; // Adjust the zoom factor
                zoom = Math.max(0.1, zoom); // Set a minimum zoom level
                group.scaleX = zoom; // Apply the zoom to the X-axis
                group.scaleY = zoom; // Apply the zoom to the Y-axis
                                // Adjust icons' scale to maintain their original size
                group.getObjects().forEach(function(obj) {
                    if (obj !== img) { // Exclude the main image
                        obj.scaleX = originalIconScale / group.scaleX;
                        obj.scaleY = originalIconScale / group.scaleY;
                    }
                });

                canvas.requestRenderAll(); // Re-render the canvas
                event.e.preventDefault(); // Prevent default scroll behavior
                event.e.stopPropagation(); // Stop event propagation
                canvas.requestRenderAll(); // Re-render the canvas with the new zoom level
            });

            // Event for mouse down
            canvas.on('mouse:down', function(event) {
                console.log(getImageCoordinates(event));
                if (event.e.button === 0) { // Left mouse button (button === 0)
                    if (isPKeyActive) {
                        // Get the pointer position on the canvas
                        const pointer = canvas.getPointer(event.e);
                        const px = pointer.x;
                        const py = pointer.y;

                        // Add an icon at the click position
                        addIcon('https://cdn-icons-png.flaticon.com/512/1828/1828774.png', px, py); // Example icon URL

                    } else if (isDKeyActive){
                        const pointer = canvas.getPointer(event.e);
                        const px = pointer.x;
                        const py = pointer.y;
                        deleteNearestIconGroup(px, py);
                         
                    } else {
                        isDragging = true;
                        lastPosX = event.e.clientX;
                        lastPosY = event.e.clientY;
                        event.e.preventDefault();
                    }
                }

                    
                // alert(event.e.button);
                else if (event.e.button === 2) { // Right-click (button === 2)
                    isRightClickDragging = true;
                    startX = event.e.clientX; // Store initial X position
                    event.e.preventDefault(); // Prevent default context menu
                }
            });

            // Event for mouse move
            canvas.on('mouse:move', function(event) {
                if (isDragging)
                {
                    const currentPosX = event.e.clientX;
                    const currentPosY = event.e.clientY;

                    // Calculate the difference in X and Y positions
                    const deltaX = currentPosX - lastPosX;
                    const deltaY = currentPosY - lastPosY;

                    // Update the image position based on the mouse movement
                    group.left += deltaX;
                    group.top += deltaY;

                    // Update the last position for continuous movement
                    lastPosX = currentPosX;
                    lastPosY = currentPosY;

                    canvas.requestRenderAll(); // Re-render the canvas with the new position

                } else if (isRightClickDragging) {
                    const currentX = event.e.clientX; // Get current X position
                    const deltaX = currentX - startX; // Calculate the difference in X

                    // Adjust the rotation angle based on the mouse movement
                    group.rotate(group.angle - deltaX * 0.2); // Adjust the multiplier for sensitivity
                    canvas.requestRenderAll(); // Re-render the canvas with the new rotation

                    // Update the start position for continuous rotation
                    startX = currentX;
                } else {
                 
                }
            });

            // Event for mouse up
            canvas.on('mouse:up', function(event) {
                // Check which mouse button was released
                if (event.e.button === 0) { // Left mouse button
                    isDragging = false; // Stop the left-click drag movement
                } else if (event.e.button === 2) { // Right mouse button
                 
                    isRightClickDragging = false; // Stop the right-click drag rotation
                }
            });

       
        });

        // Prevent the default right-click context menu on the entire canvas
        //document.getElementById('canvas-container').addEventListener('contextmenu', function(event) {
        //    event.preventDefault();
        //});
    </script>
</body>
</html>